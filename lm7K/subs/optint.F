      subroutine optint(sctrl,soptic,sbz,eband,nbmax,ksp,nsp,nspc,ikp,
     .  efermi,idtet,wgts,vol,nfilm,nempm,nptmx,yy,optpar,optmt,opt)
C- BZ integration of Im(eps) or joint DOS
C ----------------------------------------------------------------------
Ci Inputs:
Ci   sctrl :struct containing parameters governing program flow
Ci     Elts read: loptc
Ci         loptc:   1 generate Im(eps) (optics package)
Ci                  2 generate Im(eps) w/ on-the-fly sampling integration
Ci                 -1 generate joint DOS
Ci                Add 10 for SHG
Ci   soptic:struct containing parameters for optical ME
Ci     Elts read: mode ne window ocrng unrng esciss
Ci   sbz   :struct containing parameters for the BZ
Ci     Elts read: nkabc nkp ntet lmet
Ci   eband :energy bands for irreducible part of BZ
Ci   nbmax :leading dimension of eband
Ci   ksp   :starting spin index passed to mkjdos.  Used for 
Ci         :on-the-fly sampling integration (partial contribution),
Ci         :when only information for second-spin is available.
Ci         :See Remarks
Ci   nsp   :number of spins if nspc=1, 1 if nspc=2
Ci   nspc  :2 for noncoll or S/O; otherwise 1
Ci   ikp   :current k-point (sampling integration only)
Ci         :If ikp>0, partial contribution from a single
Ci         :k-point (ikp) and spin (ksp) accumulated (see Remarks)
Ci         :ikp<0 signifies that information from all k-point are
Ci         :to be accumulated.
Ci   efermi:Fermi level
Ci         :NB: efermi=-99 is a flag, indicating that the Fermi
Ci         :level is not set.
Ci   idtet :(0,i) no. of tetrahedra of the i'th kind
Ci         :(1-4,i) identifies the i'th tetrahedron in terms of
Ci         :four irreducible k-points
Ci   vol   :volume
Ci   nfilm,nempm: dimensions optmt
Ci   nptmx :max number of bins; dimension for following 3 work arrays
Ci   yy    :work array of dimension nptmx
Ci   optpar:work array of dimension nptmx*3
Ci   optmt :<i|grad|j> connecting occ i with unocc j
Ci         :NB: optmt is NOT initialized by this routine.
Ci         :Caller should set optmt=0 before first call to optint.
Co Outputs:
Co   opt   :Im(epsilon), unscaled by weight 16*pi**2/vol/e**2
Co         :opt is either :
Co         :(1) generated and the scaled epsilon written to file 'opt'
Co          (when information for all k-points is available; see ikp);
Co         :(2) partial contribution added to the unscaled epsilon
Co          (when information for 1 k-points is available; see ikp);
Co         :NB: output may be joint DOS instead of Im eps; see jdos
Co         :    below
Cr Remarks
Cr   Adapted from bzints to make joint density of states or Im(eps)
Cr   All energy differences between states below ef and states
Cr   above ef+emin are summed, and integrated over the BZ
Cr   Treatment near the critical points (ef and ef+emin) handled crudely
Cr   Optics package adapted from Sergey Rashkeev with Walter Lambrecht,
Cr   which was adapted from an earlier version by V. Antropov.
Cr
Cr   (Sampling only) The partial contribution to Im(eps) may be made from 
Cr   a single k-point and spin.  This routine accumulates contributions from
Cr   all k-points uness ikp>0, in which case it accumulates a
Cr   partial contribution from (ikp,ksp) only.
Cu Updates
Cu   15 Jan 04 (Uk-Jin Roh) add partial sampling contribution to Im(eps)
Cu   20 Nov 02 (jek) extended to metals
Cu   02 Mar 01 Added scissors operator
Cu   20 Dec 00 (wrl) extended to noncollinear case
C ----------------------------------------------------------------------
C     implicit none
C Passed parameters
      integer nbmax,nsp,nspc,idtet(0:4,*),npts,nfilm,nempm,nptmx,ksp,ikp
      double precision sctrl(1),sbz(1),soptic(1),efermi,vol
      double precision yy(nptmx),opt(nptmx,3,nsp),optpar(nptmx,3)
      double precision optmt(3,nfilm,nempm,nsp,*),wgts(*),
     .                 eband(nbmax,nsp,*)

      call rx('OPTINT not installed; optics library required')
      end
      subroutine optin2(sctrl,soptic,sbz,nsp,nspc,vol,nptmx,opt)
C- File output for Im(eps) or joint DOS, generated by optint
C ----------------------------------------------------------------------
Ci Inputs:
Ci   sctrl :struct containing parameters governing program flow
Ci     Elts read: loptc
Ci   soptic:struct containing parameters for optical ME
Ci     Elts read: mode ne window ocrng unrng esciss
Ci   sbz   :struct containing parameters for the BZ
Ci     Elts read: nkabc nkp ntet lmet
Ci   nsp   :number of spins if nspc=1, 1 if nspc=2
Ci   nspc  :2 for noncoll or S/O; otherwise 1
Ci   vol   :volume
Ci   nptmx :max number of bins; dimension for following 3 work arrays
Ci   opt:  :Im(eps)
Co Outputs:
Co   opt:  written to file 'opt'
Cr Remarks
Cu Updates
Cu   15 Jan 04 (Uk-Jin Roh) first created
C ----------------------------------------------------------------------
C     implicit none
C Passed parameters
      integer nsp,nspc,npts,nptmx
      double precision sctrl(1),sbz(1),soptic(1),vol
      double precision opt(nptmx,3,nsp)
      call rx('OPTINT not installed; optics library required')
      end

